<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panguard Admin - Users</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/admin/icons.js"></script>
  <script src="/admin/shared.js"></script>
  <script>tailwind.config = PG.TAILWIND_CONFIG;</script>
  <style>
    .stat-card { transition: border-color 0.2s; }
    .stat-card:hover { border-color: #8B9A8E; }
    @keyframes slide-in { from { transform: translateX(100%); } to { transform: translateX(0); } }
    @keyframes slide-out { from { transform: translateX(0); } to { transform: translateX(100%); } }
    .drawer-in { animation: slide-in 0.25s ease-out forwards; }
    .drawer-out { animation: slide-out 0.2s ease-in forwards; }
  </style>
</head>
<body class="bg-surface-0 text-text-primary min-h-screen">
  <div id="nav"></div>

  <main class="max-w-7xl mx-auto px-6 py-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-xl font-bold flex items-center gap-2">
        <span id="pageIcon"></span>
        Users
        <span id="totalBadge" class="text-xs font-normal text-text-tertiary bg-surface-2 px-2 py-0.5 rounded-full"></span>
      </h1>
      <button onclick="exportCsv()" class="flex items-center gap-1.5 px-3 py-1.5 text-xs rounded-lg border border-border text-text-secondary hover:border-sage hover:text-sage transition-colors">
        ${Icons.download(14)}
        Export CSV
      </button>
    </div>

    <!-- Search + Filters -->
    <div class="flex items-center gap-3 mb-4">
      <div class="relative flex-1 max-w-md">
        <div class="absolute left-3 top-1/2 -translate-y-1/2 text-text-muted" id="searchIcon"></div>
        <input type="text" id="searchInput" placeholder="Search by email or name..."
          class="w-full bg-surface-1 border border-border rounded-lg pl-10 pr-4 py-2 text-sm text-text-primary placeholder-text-muted focus:outline-none focus:border-sage transition-colors">
      </div>
      <select id="roleFilter"
        class="bg-surface-1 border border-border rounded-lg px-3 py-2 text-sm text-text-secondary focus:outline-none focus:border-sage">
        <option value="">All Roles</option>
        <option value="admin">Admin</option>
        <option value="user">User</option>
      </select>
      <select id="tierFilter"
        class="bg-surface-1 border border-border rounded-lg px-3 py-2 text-sm text-text-secondary focus:outline-none focus:border-sage">
        <option value="">All Tiers</option>
        <option value="free">Free</option>
        <option value="solo">Solo</option>
        <option value="starter">Starter</option>
        <option value="pro">Pro</option>
        <option value="team">Team</option>
        <option value="business">Business</option>
        <option value="enterprise">Enterprise</option>
      </select>
    </div>

    <!-- Users Table -->
    <div class="bg-surface-1 border border-border rounded-xl overflow-hidden">
      <table class="w-full">
        <thead>
          <tr class="border-b border-border">
            <th class="text-left text-xs text-text-tertiary font-normal px-4 py-3 w-8">
              <input type="checkbox" id="selectAll" class="accent-sage cursor-pointer" onchange="toggleSelectAll(this.checked)">
            </th>
            <th class="text-left text-xs text-text-tertiary font-normal px-4 py-3">Email</th>
            <th class="text-left text-xs text-text-tertiary font-normal px-4 py-3">Name</th>
            <th class="text-left text-xs text-text-tertiary font-normal px-4 py-3">Tier</th>
            <th class="text-left text-xs text-text-tertiary font-normal px-4 py-3">Role</th>
            <th class="text-left text-xs text-text-tertiary font-normal px-4 py-3">Status</th>
            <th class="text-left text-xs text-text-tertiary font-normal px-4 py-3">Last Login</th>
            <th class="text-left text-xs text-text-tertiary font-normal px-4 py-3 w-10"></th>
          </tr>
        </thead>
        <tbody id="usersTable"></tbody>
      </table>
    </div>

    <div id="noUsers" class="hidden text-center py-12 text-text-tertiary text-sm">No users found</div>
    <div id="paginationContainer"></div>
  </main>

  <!-- Bulk Action Bar -->
  <div id="bulkBar" class="fixed bottom-0 left-0 right-0 bg-surface-1 border-t border-border px-6 py-3 flex items-center gap-4 z-40 transition-transform translate-y-full" style="transition:transform 0.2s">
    <span id="bulkCount" class="text-sm font-semibold text-sage">0 selected</span>
    <div class="flex-1"></div>
    <select id="bulkTier" class="bg-surface-2 border border-border rounded-lg px-3 py-1.5 text-xs focus:outline-none focus:border-sage">
      <option value="">Change Tier...</option>
      <option value="free">Free</option>
      <option value="solo">Solo</option>
      <option value="starter">Starter</option>
      <option value="pro">Pro</option>
      <option value="team">Team</option>
      <option value="business">Business</option>
      <option value="enterprise">Enterprise</option>
    </select>
    <button onclick="bulkChangeTier()" class="px-3 py-1.5 text-xs rounded-lg bg-sage/10 text-sage border border-sage/20 hover:bg-sage/20 transition-colors">Apply Tier</button>
    <select id="bulkRole" class="bg-surface-2 border border-border rounded-lg px-3 py-1.5 text-xs focus:outline-none focus:border-sage">
      <option value="">Change Role...</option>
      <option value="user">User</option>
      <option value="admin">Admin</option>
    </select>
    <button onclick="bulkChangeRole()" class="px-3 py-1.5 text-xs rounded-lg bg-sage/10 text-sage border border-sage/20 hover:bg-sage/20 transition-colors">Apply Role</button>
    <button onclick="bulkSuspend()" class="px-3 py-1.5 text-xs rounded-lg bg-danger/10 text-danger border border-danger/20 hover:bg-danger/20 transition-colors flex items-center gap-1">
      ${Icons.ban(12)} Suspend
    </button>
  </div>

  <!-- User Detail Drawer -->
  <div id="drawerOverlay" class="hidden fixed inset-0 bg-black/50 z-40" onclick="closeDrawer()"></div>
  <div id="drawer" class="fixed top-0 right-0 h-full w-[420px] bg-surface-1 border-l border-border z-50 overflow-y-auto hidden">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-sm font-semibold">User Details</h2>
        <button onclick="closeDrawer()" class="text-text-muted hover:text-text-secondary">${Icons.xMark(18)}</button>
      </div>
      <div id="drawerContent">
        <div class="text-sm text-text-tertiary">Loading...</div>
      </div>
    </div>
  </div>

  <script>
    if (!PG.requireAuth()) throw new Error('Not authenticated');

    document.getElementById('nav').innerHTML = PG.renderNav('users');
    document.getElementById('pageIcon').innerHTML = Icons.users(20, '#8B9A8E');
    document.getElementById('searchIcon').innerHTML = Icons.search(16);

    const TIERS = ['free', 'solo', 'starter', 'pro', 'team', 'business', 'enterprise'];
    const ROLES = ['user', 'admin'];

    let allUsers = [];
    let currentPage = 1;
    const PER_PAGE = 20;
    let selectedIds = new Set();

    // ── Debounced Search ──
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => { currentPage = 1; renderTable(); }, 300);
    });
    document.getElementById('roleFilter').addEventListener('change', () => { currentPage = 1; renderTable(); });
    document.getElementById('tierFilter').addEventListener('change', () => { currentPage = 1; renderTable(); });

    function getFilteredUsers() {
      const query = document.getElementById('searchInput').value.toLowerCase().trim();
      const roleFilter = document.getElementById('roleFilter').value;
      const tierFilter = document.getElementById('tierFilter').value;

      return allUsers.filter(u => {
        if (query && !u.email.toLowerCase().includes(query) && !u.name.toLowerCase().includes(query)) return false;
        if (roleFilter && u.role !== roleFilter) return false;
        if (tierFilter && u.tier !== tierFilter) return false;
        return true;
      });
    }

    function renderTable() {
      const filtered = getFilteredUsers();
      const p = PG.paginate(filtered, currentPage, PER_PAGE);

      document.getElementById('totalBadge').textContent = `${filtered.length} users`;
      document.getElementById('noUsers').classList.toggle('hidden', p.items.length > 0);

      const tbody = document.getElementById('usersTable');
      tbody.innerHTML = p.items.map(u => {
        const isSuspended = u.suspended === 1;
        const checked = selectedIds.has(u.id) ? 'checked' : '';
        const suspendedBadge = isSuspended
          ? `<span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-medium bg-danger/10 text-danger border border-danger/20">${Icons.ban(10)} Suspended</span>`
          : `<span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-medium bg-safe/10 text-safe border border-safe/20">${Icons.checkCircle(10, '#2ED573')} Active</span>`;

        return `<tr class="border-b border-border/50 hover:bg-surface-2/30 transition-colors ${isSuspended ? 'bg-danger/5' : ''}">
          <td class="px-4 py-3">
            <input type="checkbox" class="accent-sage cursor-pointer" ${checked} onchange="toggleSelect(${u.id}, this.checked)">
          </td>
          <td class="px-4 py-3 text-sm cursor-pointer hover:text-sage transition-colors" onclick="openDrawer(${u.id})">${PG.escapeHtml(u.email)}</td>
          <td class="px-4 py-3 text-sm text-text-secondary">${PG.escapeHtml(u.name)}</td>
          <td class="px-4 py-3">
            <select onchange="updateTier(${u.id}, this.value)"
              class="bg-surface-2 border border-border rounded px-2 py-1 text-xs ${PG.TIER_COLORS[u.tier] || 'text-text-secondary'} focus:outline-none focus:border-sage cursor-pointer">
              ${TIERS.map(t => `<option value="${t}" ${t === u.tier ? 'selected' : ''}>${t}</option>`).join('')}
            </select>
          </td>
          <td class="px-4 py-3">
            <select onchange="updateRole(${u.id}, this.value)"
              class="bg-surface-2 border border-border rounded px-2 py-1 text-xs text-text-secondary focus:outline-none focus:border-sage cursor-pointer">
              ${ROLES.map(r => `<option value="${r}" ${r === u.role ? 'selected' : ''}>${r}</option>`).join('')}
            </select>
          </td>
          <td class="px-4 py-3">${suspendedBadge}</td>
          <td class="px-4 py-3 text-xs text-text-tertiary">${PG.formatRelativeTime(u.lastLogin)}</td>
          <td class="px-4 py-3">
            <button onclick="toggleSuspend(${u.id}, ${isSuspended ? 'false' : 'true'})" title="${isSuspended ? 'Unsuspend' : 'Suspend'}"
              class="p-1 rounded hover:bg-surface-2 transition-colors ${isSuspended ? 'text-safe hover:text-safe' : 'text-text-muted hover:text-danger'}">
              ${isSuspended ? Icons.checkCircle(16, '#2ED573') : Icons.ban(16)}
            </button>
          </td>
        </tr>`;
      }).join('');

      document.getElementById('paginationContainer').innerHTML =
        PG.renderPagination(p, pg => { currentPage = pg; renderTable(); });

      updateBulkBar();
    }

    // ── Selection ──
    function toggleSelect(userId, checked) {
      if (checked) selectedIds.add(userId);
      else selectedIds.delete(userId);
      updateBulkBar();
    }

    function toggleSelectAll(checked) {
      const filtered = getFilteredUsers();
      const p = PG.paginate(filtered, currentPage, PER_PAGE);
      for (const u of p.items) {
        if (checked) selectedIds.add(u.id);
        else selectedIds.delete(u.id);
      }
      renderTable();
    }

    function updateBulkBar() {
      const bar = document.getElementById('bulkBar');
      if (selectedIds.size > 0) {
        bar.style.transform = 'translateY(0)';
        document.getElementById('bulkCount').textContent = `${selectedIds.size} selected`;
      } else {
        bar.style.transform = 'translateY(100%)';
      }
    }

    // ── Bulk Actions ──
    async function bulkChangeTier() {
      const tier = document.getElementById('bulkTier').value;
      if (!tier) { PG.showToast('Select a tier first', 'warning'); return; }
      const data = await PG.apiPost('/api/admin/users/bulk-action', {
        userIds: Array.from(selectedIds), action: 'change_tier', value: tier,
      });
      if (data && data.ok) {
        PG.showToast(`${data.data.processed} users updated to ${tier}`, 'success');
        selectedIds.clear();
        document.getElementById('bulkTier').value = '';
        await loadUsers();
      } else {
        PG.showToast(data?.error || 'Bulk action failed', 'error');
      }
    }

    async function bulkChangeRole() {
      const role = document.getElementById('bulkRole').value;
      if (!role) { PG.showToast('Select a role first', 'warning'); return; }
      const data = await PG.apiPost('/api/admin/users/bulk-action', {
        userIds: Array.from(selectedIds), action: 'change_role', value: role,
      });
      if (data && data.ok) {
        PG.showToast(`${data.data.processed} users updated to ${role}`, 'success');
        selectedIds.clear();
        document.getElementById('bulkRole').value = '';
        await loadUsers();
      } else {
        PG.showToast(data?.error || 'Bulk action failed', 'error');
      }
    }

    async function bulkSuspend() {
      const data = await PG.apiPost('/api/admin/users/bulk-action', {
        userIds: Array.from(selectedIds), action: 'suspend',
      });
      if (data && data.ok) {
        PG.showToast(`${data.data.processed} users suspended`, 'success');
        selectedIds.clear();
        await loadUsers();
      } else {
        PG.showToast(data?.error || 'Bulk action failed', 'error');
      }
    }

    // ── Suspend/Unsuspend ──
    async function toggleSuspend(userId, suspend) {
      const data = await PG.apiPatch(`/api/admin/users/${userId}/suspend`, { suspended: suspend });
      if (data && data.ok) {
        const u = allUsers.find(u => u.id === userId);
        if (u) u.suspended = suspend ? 1 : 0;
        PG.showToast(suspend ? 'User suspended' : 'User unsuspended', 'success');
        renderTable();
      } else {
        PG.showToast(data?.error || 'Action failed', 'error');
      }
    }

    // ── Tier/Role Update ──
    async function updateTier(userId, tier) {
      const data = await PG.apiPatch(`/api/admin/users/${userId}/tier`, { tier });
      if (data && data.ok) {
        const u = allUsers.find(u => u.id === userId);
        if (u) u.tier = tier;
        PG.showToast(`Tier updated to ${tier}`, 'success');
        renderTable();
      }
    }

    async function updateRole(userId, role) {
      const data = await PG.apiPatch(`/api/admin/users/${userId}/role`, { role });
      if (data && data.ok) {
        const u = allUsers.find(u => u.id === userId);
        if (u) u.role = role;
        PG.showToast(`Role updated to ${role}`, 'success');
        renderTable();
      }
    }

    // ── User Detail Drawer ──
    async function openDrawer(userId) {
      const overlay = document.getElementById('drawerOverlay');
      const drawer = document.getElementById('drawer');
      const content = document.getElementById('drawerContent');

      overlay.classList.remove('hidden');
      drawer.classList.remove('hidden');
      drawer.classList.remove('drawer-out');
      drawer.classList.add('drawer-in');
      content.innerHTML = '<div class="text-sm text-text-tertiary">Loading...</div>';

      const data = await PG.apiFetch(`/api/admin/users/${userId}`);
      if (!data || !data.ok) {
        content.innerHTML = '<div class="text-sm text-danger">Failed to load user details</div>';
        return;
      }

      const d = data.data;
      const u = d.user;
      const isSuspended = u.suspended === 1;

      let html = '';

      // Profile section
      html += `<div class="mb-6">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 rounded-full bg-sage/10 flex items-center justify-center">${Icons.user(20, '#8B9A8E')}</div>
          <div>
            <div class="font-semibold text-sm">${PG.escapeHtml(u.name || u.email)}</div>
            <div class="text-xs text-text-tertiary">${PG.escapeHtml(u.email)}</div>
          </div>
        </div>
        <div class="grid grid-cols-2 gap-3 text-xs">
          <div><span class="text-text-tertiary">Tier:</span> <span class="${PG.TIER_COLORS[u.tier] || 'text-text-secondary'} font-semibold">${u.tier}</span></div>
          <div><span class="text-text-tertiary">Role:</span> <span class="text-text-secondary">${u.role}</span></div>
          <div><span class="text-text-tertiary">Verified:</span> ${u.verified ? '<span class="text-safe">Yes</span>' : '<span class="text-text-muted">No</span>'}</div>
          <div><span class="text-text-tertiary">Status:</span> ${isSuspended ? '<span class="text-danger">Suspended</span>' : '<span class="text-safe">Active</span>'}</div>
          <div><span class="text-text-tertiary">Created:</span> <span class="text-text-secondary">${PG.formatDate(u.createdAt)}</span></div>
          <div><span class="text-text-tertiary">Last Login:</span> <span class="text-text-secondary">${PG.formatRelativeTime(u.lastLogin)}</span></div>
          <div><span class="text-text-tertiary">2FA:</span> ${d.twoFactor.enabled ? '<span class="text-safe">Enabled</span>' : '<span class="text-text-muted">Disabled</span>'}</div>
        </div>
      </div>`;

      // Subscription
      if (d.subscription) {
        const sub = d.subscription;
        html += `<div class="mb-6">
          <h3 class="text-xs font-semibold text-text-tertiary uppercase tracking-wider mb-2">Subscription</h3>
          <div class="bg-surface-2 rounded-lg p-3 text-xs space-y-1">
            <div><span class="text-text-tertiary">Status:</span> <span class="text-text-secondary">${sub.status}</span></div>
            <div><span class="text-text-tertiary">Tier:</span> <span class="${PG.TIER_COLORS[sub.tier] || ''}">${sub.tier}</span></div>
            ${sub.renewsAt ? `<div><span class="text-text-tertiary">Renews:</span> <span class="text-text-secondary">${PG.formatDate(sub.renewsAt)}</span></div>` : ''}
            ${sub.endsAt ? `<div><span class="text-text-tertiary">Ends:</span> <span class="text-text-secondary">${PG.formatDate(sub.endsAt)}</span></div>` : ''}
          </div>
        </div>`;
      }

      // Usage
      if (d.usage && d.usage.length > 0) {
        html += `<div class="mb-6">
          <h3 class="text-xs font-semibold text-text-tertiary uppercase tracking-wider mb-2">Usage</h3>
          <div class="space-y-2">`;
        for (const item of d.usage) {
          const pct = item.percentage;
          const barColor = pct >= 95 ? 'bg-danger' : pct >= 80 ? 'bg-caution' : 'bg-sage';
          const textColor = pct >= 95 ? 'text-danger' : pct >= 80 ? 'text-caution' : 'text-text-secondary';
          html += `<div>
            <div class="flex items-center justify-between text-xs mb-0.5">
              <span class="text-text-tertiary capitalize">${item.resource.replace(/_/g, ' ')}</span>
              <span class="${textColor} font-mono">${PG.formatNumber(item.current)} / ${item.limit === -1 ? 'unlimited' : PG.formatNumber(item.limit)}</span>
            </div>
            ${item.limit !== -1 ? `<div class="h-1.5 bg-surface-0 rounded-full overflow-hidden">
              <div class="${barColor} h-full rounded-full" style="width:${Math.min(100, pct)}%"></div>
            </div>` : ''}
          </div>`;
        }
        html += `</div></div>`;
      }

      // Sessions
      if (d.sessions && d.sessions.length > 0) {
        html += `<div class="mb-6">
          <h3 class="text-xs font-semibold text-text-tertiary uppercase tracking-wider mb-2">Active Sessions (${d.sessions.length})</h3>
          <div class="space-y-1">`;
        for (const s of d.sessions) {
          html += `<div class="bg-surface-2 rounded-lg px-3 py-2 text-xs flex items-center justify-between">
            <span class="text-text-secondary font-mono">#${s.id}</span>
            <span class="text-text-tertiary">Expires ${PG.formatRelativeTime(s.expiresAt)}</span>
          </div>`;
        }
        html += `</div></div>`;
      }

      // Recent Audit
      if (d.recentAudit && d.recentAudit.length > 0) {
        html += `<div class="mb-6">
          <h3 class="text-xs font-semibold text-text-tertiary uppercase tracking-wider mb-2">Recent Activity</h3>
          <div class="space-y-1">`;
        for (const a of d.recentAudit) {
          html += `<div class="bg-surface-2 rounded-lg px-3 py-2 text-xs flex items-center justify-between">
            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-sage/10 text-sage">${PG.escapeHtml(a.action)}</span>
            <span class="text-text-tertiary">${PG.formatRelativeTime(a.createdAt)}</span>
          </div>`;
        }
        html += `</div></div>`;
      }

      // Actions
      html += `<div class="border-t border-border pt-4 flex gap-2">
        <button onclick="toggleSuspend(${u.id}, ${isSuspended ? 'false' : 'true'}); closeDrawer();"
          class="flex-1 px-3 py-2 text-xs rounded-lg ${isSuspended ? 'bg-safe/10 text-safe border border-safe/20 hover:bg-safe/20' : 'bg-danger/10 text-danger border border-danger/20 hover:bg-danger/20'} transition-colors flex items-center justify-center gap-1">
          ${isSuspended ? Icons.checkCircle(14, '#2ED573') + ' Unsuspend' : Icons.ban(14) + ' Suspend'}
        </button>
      </div>`;

      content.innerHTML = html;
    }

    function closeDrawer() {
      const overlay = document.getElementById('drawerOverlay');
      const drawer = document.getElementById('drawer');
      drawer.classList.remove('drawer-in');
      drawer.classList.add('drawer-out');
      setTimeout(() => {
        drawer.classList.add('hidden');
        overlay.classList.add('hidden');
      }, 200);
    }

    // ── CSV Export ──
    function exportCsv() {
      const columns = [
        { key: 'email', label: 'Email' },
        { key: 'name', label: 'Name' },
        { key: 'tier', label: 'Tier' },
        { key: 'role', label: 'Role' },
        { key: 'verified', label: 'Verified' },
        { key: 'suspended', label: 'Suspended' },
        { key: 'lastLogin', label: 'Last Login' },
        { key: 'createdAt', label: 'Created' },
      ];
      const rows = allUsers.map(u => ({
        email: u.email,
        name: u.name,
        tier: u.tier,
        role: u.role,
        verified: u.verified ? 'Yes' : 'No',
        suspended: u.suspended ? 'Yes' : 'No',
        lastLogin: u.lastLogin || '',
        createdAt: u.createdAt || '',
      }));
      const csv = PG.generateCsv(columns, rows);
      PG.downloadCsv('panguard-users.csv', csv);
      PG.showToast('CSV exported', 'success');
    }

    // ── Load Users ──
    async function loadUsers() {
      const data = await PG.apiFetch('/api/admin/users');
      if (!data || !data.ok) return;
      allUsers = data.data;
      renderTable();
    }

    loadUsers();
  </script>
</body>
</html>

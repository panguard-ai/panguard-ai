/**
 * Security vulnerability scanner
 * 安全漏洞掃描器
 *
 * Detects known vulnerabilities and generates audit reports.
 * 偵測已知漏洞並產生稽核報告。
 *
 * @module @openclaw/security-hardening/scanner/vulnerability-scanner
 */

import { createLogger } from '@openclaw/core';
import type { SecurityPolicy, VulnerabilityFinding, SecurityAuditReport } from '../types.js';
import { DEFAULT_SECURITY_POLICY } from '../permissions/security-policy.js';
import { scanPlaintextCredentials } from '../credentials/migration.js';

const logger = createLogger('scanner:vulnerability');

const HARDENING_VERSION = '0.1.0';

/** Severity weights for risk score calculation / 嚴重程度權重用於風險評分計算 */
const SEVERITY_WEIGHTS: Record<string, number> = {
  info: 0,
  low: 10,
  medium: 25,
  high: 50,
  critical: 100,
};

/**
 * Check CVE-2026-25253: WebSocket authentication bypass
 * 檢查 CVE-2026-25253：WebSocket 認證繞過
 */
function checkWebSocketAuth(policy: SecurityPolicy): VulnerabilityFinding {
  const hasCsrf = policy.requireCsrfToken;
  const hasOriginCheck = policy.allowedOrigins.length > 0;
  const fixed = hasCsrf && hasOriginCheck;

  return {
    id: 'CVE-2026-25253',
    severity: fixed ? 'info' : 'high',
    title: 'WebSocket Cross-Site Authentication Hijacking / WebSocket 跨站認證劫持',
    description: fixed
      ? 'CSRF token and Origin validation are enabled. / CSRF token 和 Origin 驗證已啟用。'
      : 'WebSocket connections lack CSRF protection and/or Origin validation. / WebSocket 連線缺少 CSRF 保護和/或 Origin 驗證。',
    component: 'WebSocket Gateway',
    remediation: 'Enable requireCsrfToken and configure allowedOrigins in security policy. / 在安全政策中啟用 requireCsrfToken 並配置 allowedOrigins。',
    fixed,
  };
}

/**
 * Check for plaintext credential storage
 * 檢查明文憑證儲存
 */
function checkCredentialStorage(): VulnerabilityFinding {
  const plaintext = scanPlaintextCredentials();
  const fixed = plaintext.length === 0;

  return {
    id: 'OCL-SEC-001',
    severity: fixed ? 'info' : 'high',
    title: 'Plaintext Credential Storage / 明文憑證儲存',
    description: fixed
      ? 'No plaintext credentials detected. / 未偵測到明文憑證。'
      : `Found ${plaintext.length} plaintext credential file(s). / 發現 ${plaintext.length} 個明文憑證檔案。`,
    component: 'Credential Storage',
    remediation: 'Use EncryptedFileCredentialStore and run credential migration. / 使用 EncryptedFileCredentialStore 並執行憑證遷移。',
    fixed,
  };
}

/**
 * Check Skill sandbox configuration
 * 檢查 Skill 沙盒配置
 */
function checkSkillSandbox(policy: SecurityPolicy): VulnerabilityFinding {
  const hasFilesystemRestriction = policy.allowedDirectories.length > 0;
  const hasCommandRestriction = policy.allowedCommands.length > 0;
  const noShell = !policy.allowShellAccess;
  const fixed = noShell && (hasFilesystemRestriction || hasCommandRestriction);

  return {
    id: 'OCL-SEC-002',
    severity: fixed ? 'info' : 'medium',
    title: 'Unrestricted Skill Permissions / 無限制的 Skill 權限',
    description: fixed
      ? 'Skill sandbox is properly configured. / Skill 沙盒已正確配置。'
      : 'Skills may have unrestricted filesystem and/or command execution access. / Skills 可能有無限制的檔案系統和/或命令執行存取。',
    component: 'Skill Sandbox',
    remediation: 'Set allowShellAccess=false and configure allowedDirectories/allowedCommands. / 設定 allowShellAccess=false 並配置 allowedDirectories/allowedCommands。',
    fixed,
  };
}

/**
 * Check audit logging configuration
 * 檢查稽核日誌配置
 */
function checkAuditLogging(policy: SecurityPolicy): VulnerabilityFinding {
  const fixed = policy.enableAuditLog;

  return {
    id: 'OCL-SEC-003',
    severity: fixed ? 'info' : 'low',
    title: 'Audit Logging Disabled / 稽核日誌停用',
    description: fixed
      ? 'Audit logging is enabled. / 稽核日誌已啟用。'
      : 'Security operations are not being audited. / 安全操作未被稽核。',
    component: 'Audit System',
    remediation: 'Set enableAuditLog=true in security policy. / 在安全政策中設定 enableAuditLog=true。',
    fixed,
  };
}

/**
 * Run a complete security audit
 * 執行完整安全稽核
 *
 * Scans for known vulnerabilities and generates a report with risk score.
 * 掃描已知漏洞並產生含風險評分的報告。
 *
 * @param policy - Current security policy (defaults to DEFAULT_SECURITY_POLICY) / 目前的安全政策
 * @returns Security audit report / 安全稽核報告
 */
export function runSecurityAudit(
  policy: SecurityPolicy = DEFAULT_SECURITY_POLICY
): SecurityAuditReport {
  logger.info('Starting security audit');

  const findings: VulnerabilityFinding[] = [
    checkWebSocketAuth(policy),
    checkCredentialStorage(),
    checkSkillSandbox(policy),
    checkAuditLogging(policy),
  ];

  // Calculate risk score: sum of unfixed severity weights, capped at 100
  const riskScore = Math.min(
    100,
    findings
      .filter((f) => !f.fixed)
      .reduce((sum, f) => sum + (SEVERITY_WEIGHTS[f.severity] ?? 0), 0)
  );

  const recommendations: string[] = findings
    .filter((f) => !f.fixed)
    .map((f) => f.remediation);

  const report: SecurityAuditReport = {
    timestamp: new Date().toISOString(),
    version: HARDENING_VERSION,
    findings,
    riskScore,
    recommendations,
  };

  logger.info('Security audit complete', {
    totalFindings: findings.length,
    unfixed: findings.filter((f) => !f.fixed).length,
    riskScore,
  });

  return report;
}
